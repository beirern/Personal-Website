# Workflow to
# 1. Build Image
# 2. Push to ECR
# 4. SSH to server
# 4. Pull && Run Image

name: Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-west-1
  AWS_ACCOUNT_ID: 540222592911

permissions:
  id-token: write   # This is required for requesting the JWT
  contents: write    # This is required for actions/checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH into EC2 Machine and Run new Docker Image
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          HOSTNAME: nicolabeirer.com
          USER_NAME: ${{secrets.USER_NAME}}
        run: |
          echo "$PRIVATE_KEY" >> private_key && chmod 600 private_key
          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} ' bash -lc "
            cd /home/ubuntu/Personal-Website
            git pull origin main
            pm2 restart 0
            '"
